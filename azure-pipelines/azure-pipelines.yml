trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - app/*
      - terraform/*
      - kubernetes/*
      - azure-pipelines/*

pr:
  branches:
    include:
      - main
      - develop

parameters:
  - name: action
    displayName: 'Action to perform'
    type: string
    default: 'deploy'
    values:
      - deploy
      - destroy
  - name: environment
    displayName: 'Environment'
    type: string
    default: 'dev'
    values:
      - dev
      - test
      - prod

variables:
  - template: variables/${{ parameters.environment }}.yml
  - name: dockerRegistryServiceConnection
    value: 'acr-service-connection'
  - name: imageRepository
    value: 'pyton-webapp'
  - name: dockerfilePath
    value: 'app/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Push Docker'
  condition: eq('${{ parameters.action }}', 'deploy')
  jobs:
    - job: Build
      displayName: Build
      pool:
        name: azureciagent
      steps:
        - template: templates/docker-build.yml
          parameters:
            dockerRegistryServiceConnection: $(dockerRegistryServiceConnection)
            imageRepository: $(imageRepository)
            dockerfilePath: $(dockerfilePath)
            tag: $(tag)

  # ============================================
  # STAGE 4: Terraform Plan
  # ============================================
- stage: TerraformValidate
  displayName: 'Terraform Validate - ${{ parameters.environment }}'
  dependsOn: 
    - Build
  condition: or(eq('${{ parameters.action }}', 'deploy'), eq('${{ parameters.action }}', 'destroy'))
  jobs:
    - job: TerraformValidate
      pool:
        name: azureciagent
      steps:
      - task: TerraformInstaller@1
        inputs:
          terraformVersion: '1.14.3'

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/dev'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Subscription for assessment(610ed2c5-fc7f-4033-a484-d625b87b03d9)'
          backendAzureRmResourceGroupName: 'tfstate-rg'
          backendAzureRmStorageAccountName: 'tfstatedevops1768147514'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'dev.terraform.tfstate'
      
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'validate'
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/dev'

- stage: TerraformPlan
  displayName: 'Terraform Plan - ${{ parameters.environment }}'
  dependsOn: 
    - TerraformValidate
  condition: or(eq('${{ parameters.action }}', 'deploy'), eq('${{ parameters.action }}', 'destroy'))
  jobs: 
    - job: TerraformPlan
      displayName: 'Terraform Plan'
      pool:
        name: azureciagent
      steps:
      - task: TerraformInstaller@1
        inputs:
          terraformVersion: '1.14.3'
    
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/dev'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Subscription for assessment(610ed2c5-fc7f-4033-a484-d625b87b03d9)'
          backendAzureRmResourceGroupName: 'tfstate-rg'
          backendAzureRmStorageAccountName: 'tfstatedevops1768147514'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'dev.terraform.tfstate'

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/dev'
          environmentServiceNameAzureRM: 'Subscription for assessment(610ed2c5-fc7f-4033-a484-d625b87b03d9)'
    

  # ============================================
  # STAGE 5: Terraform Apply or Destroy
  # ============================================
- stage: TerraformApply
  displayName: 'Terraform ${{ parameters.action }} - ${{ parameters.environment }}'
  dependsOn: TerraformPlan
  condition: succeeded()
  jobs:
    - job: ApprovalGate
      displayName: 'Manual Approval'
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            notifyUsers: 'devops-team@example.com'
            instructions: 'Please review Terraform plan and approve to ${{ parameters.action }} ${{ parameters.environment }} infrastructure'
            onTimeout: reject

    - job: TerraformApply
      displayName: 'Terraform Apply'
      dependsOn: ApprovalGate
      pool:
        name: azureciagent
      steps:
        - template: templates/terraform-apply.yml
          parameters:
            environment: '${{ parameters.environment }}'
            action: '${{ parameters.action }}'

  # ============================================
  # STAGE 6: Deploy to Kubernetes (only for deploy action)
  # ============================================
- stage: DeployK8s
  displayName: 'Deploy to Kubernetes - ${{ parameters.environment }}'
  dependsOn: TerraformApply
  condition: and(succeeded(), eq('${{ parameters.action }}', 'deploy'))
  jobs:
    - deployment: DeployApp
      displayName: 'Deploy Application'
      environment: '${{ parameters.environment }}'
      pool:
        name: azureciagent
      strategy:
        runOnce:
          deploy:
            steps:
              - template: templates/deploy-k8s.yml
                parameters:
                  environment: '${{ parameters.environment }}'
                  imageRepository: $(imageRepository)
                  tag: $(tag)