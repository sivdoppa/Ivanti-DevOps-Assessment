jobs:
  - job: StaticAnalysis
    displayName: 'Static Code Analysis'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.11'
      
      - script: |
          pip install bandit
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f html -o bandit-report.html || true
        displayName: 'Run Bandit security scan'
      
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'bandit-report.html'
          ArtifactName: 'SecurityReports'
  
  - job: ContainerScan
    displayName: 'Container Vulnerability Scan'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: Docker@2
        displayName: 'Build Docker image for scanning'
        inputs:
          command: build
          dockerfile: 'app/Dockerfile'
          repository: 'task-manager-scan'
          tags: 'scan'
      
      - script: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --severity HIGH,CRITICAL \
            --exit-code 0 --no-progress \
            task-manager-scan:scan
        displayName: 'Run Trivy vulnerability scan'